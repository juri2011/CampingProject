<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper

 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.campingga.mapper.GoodsMapper">
	<!-- 
		select문에서 찾을 컬럼의 내용을 sql태그로 묶어서 정리했다.
		alias: g(goods 테이블)
		
		상품번호
		카테고리
		내용
		상품이름
		판매가
		피부타입
		등록일
		수정일
		물량
		상태(판매중/재입고중/품절)
		이미지경로
		원가
		할인가
		이미지uuid
		옵션 리스트
		rownum
		총 상품 수
	 -->
	<sql id="info">
		g.goods_no as gno,
		category,
		content,
		g.pname,
		sellPrice,
		skintype,
		g.regidate,
		updatedate,
		stock,
		g.status,
		imagepath,
		originalPrice,
		discountPrice,
		uuid,
		option_list,
		ROW_NUMBER() over(ORDER BY g.regidate desc) AS rownum,
		count(1) over() AS totalCount
	</sql>
	
	<!-- 상품 상세정보 가져오기 -->
	<select id="selectOneItem" resultType="com.campingga.domain.Goods">
		select
			<include refid="info"/>  
		from goods g
		where goods_no = #{gno}
	</select>

	<!-- 카테고리 검색으로 리스트 가져오기 -->
	<select id="selectListByCategory" resultType="com.campingga.domain.Goods">
		select
			<include refid="info"/>  
		from goods g where category = #{category}
	</select>

	<!-- 카테고리와 피부타입 검색으로 리스트 가져오기 -->
	<select id="selectListByCateAndSkin"
		resultType="com.campingga.domain.Goods">
		select
			<include refid="info"/>  
		from goods g where category=#{category} and skintype=#{skintype}
	</select>

	<!-- <insert id="insertItem" parameterType="com.campingga.domain.Goods" > insert 
		into goods(category, pname, price, skintype, stock, status) values(#{category}, 
		#{pname}, #{price}, #{skintype}, #{stock}, #{status}) </insert> -->

	<!-- 상품 수정 -->
	<update id="updateItem" parameterType="com.campingga.domain.Goods">
		update goods 
		set category=#{category}, 
			pname=#{pname},
			sellPrice=#{sellPrice}, 
			originalPrice=#{originalPrice},
			discountPrice=#{discountPrice},
			content=#{content},
			imagepath=#{imagepath},
			skintype=#{skintype}, 
			stock=#{stock},
			status=#{status},
			uuid=#{uuid},
			option_list=#{option_list} 
		where goods_no=#{gno}
	</update>

	<!-- 상품삭제하기 -->
	<delete id="deleteItem">
		delete from goods where goods_no = #{gno}
	</delete>
	<!-- <select id="selectImageList" resultType="com.campingga.domain.Goods"> 
		select * from goodsImage where goods_no = #{gno} </select> -->

	<!--
		registerGoods()에 사용되는 쿼리
		상품등록하기
		useGeneratedKeys -> insert후 pk값 얻어오기	
	-->
	<insert id="insertItem" parameterType="com.campingga.domain.Goods" useGeneratedKeys="true" keyProperty="gno">
		INSERT INTO goods (category, pname, content, sellPrice, skintype,
		stock, status, imagepath, originalPrice, discountPrice, uuid,
		option_list)
		VALUES (
		#{category},
		#{pname},
		#{content},
		#{sellPrice},
		#{skintype},
		#{stock},
		#{status},
		#{imagepath},
		#{originalPrice},
		#{discountPrice},
		#{uuid},
		#{option_list}
		)
	</insert>

	<!-- 다음 데이터에 들어갈 아이디값구하기 -->
	<select id="getGoodsNo" resultType="int">
		SELECT max(last_insert_id(goods_no))+1 FROM goods
	</select>
	
	<!--
		controller의 goodsList에서 사용(/showlist)
		
		pagination으로 아이템 리스트 구하기
		goods 테이블 전체
		no/s_uuid : 서버에 들어갈 이미지 경로
		행숫자
		전체 아이템 수
	-->
	<select id="goodsList" parameterType="com.campingga.domain.Common" resultType="com.campingga.domain.Goods">
	select * from (
		select
			goods_no as gno,
			g.*,
			concat(goods_no,'/s_',uuid) as simagepath,
			ROW_NUMBER() over(ORDER BY regidate desc) AS rownum,
			count(1) over() AS totalCount 	
		from goods g
	) g
	WHERE rownum BETWEEN (#{section}-1)*20*100+(#{pageNum}-1)*20+1 AND (#{section}-1)*100+#{pageNum}*20
	order by rownum
	
	</select>
	
	<!-- 
		컨트롤러의 goodsList() /showlist에서 사용
		검색으로 리스트 가져오기
		where 1=1 대신에 trim 사용하는 것이 좋을듯
	 -->
	<select id="selectSearchList" parameterType="com.campingga.domain.Common" resultType="com.campingga.domain.Goods">
		select
			goods_no as gno,
			g.*,
			concat(goods_no,'/s_',uuid) as simagepath
		from goods g
		where 1=1
			<if test='searchId != null and searchId != ""'>
				and ${searchId}
			</if>
			<if test='searchText != null and searchText != ""'>
				like concat('%',#{searchText},'%')
			</if>
			<if test='category != null and category != 0'>
				and category like concat('%',#{category},'%')
			</if>
			<if test='price1 != 0 and price2 != 0'>
			</if>
	</select>

	<!-- 이미지 파일 업로드 경로 -->
	<update id="updateFilePath" parameterType="com.campingga.domain.Goods">
		update goods set imagepath=#{imagepath}, uuid=#{uuid}
		where goods_no = #{gno}
	</update>

	<!-- 
		parcelDate -> 배송일?
		dstatus -> orderlist테이블 배송상태(1/2/3/4)
		dstatusStr -> orderList (배송전/출고완료/배송중/배송완료)
		payDate -> orderList 등록일
		waybill_num -> 
		parcelCd -> orderList 배송코드
		orderlist_no -> 주문번호
	 -->
	<select id="selectGoodsOrderList" parameterType="com.campingga.domain.Common" resultType="com.campingga.domain.Goods">
		select
			c.update_date as parcelDate,
			dstatus,
			case
			    when o.dstatus= '1' then '배송전'
			    when o.dstatus= '2' then '출고완료'
			    when o.dstatus= '3' then '배송중'
			   	when o.dstatus= '4' then '배송완료'
			    else '배송정보사용불가'
			end as dstatusStr,
			DATE_FORMAT(o.regiDate,'%Y.%m.%d') as payDate,
			o.waybill_num as waybillNum,
			o.parcel_cd as parcelCd,
			o.orderlist_no as orderNo,
			<include refid="info"/>
		from goods g
		inner join cart c on(g.goods_no = c.goods_no)
		inner join orderlist o on(o.orderlist_no = c.ordernum)
		where c.mem_id = #{memId}
	</select>


</mapper>